function doSearchCallBack(e){var a=window.g_search[e];return function(e){var d,n;if(e=safeHtml(e),idx=e.indexOf('<div class="dui-container nav">'),endIdx=e.indexOf('<div class="dui-container main">'),idx>0&&endIdx>idx){if(nav=e.substring(idx,endIdx),n=$(nav).find(".keyword").text().split(/[「」]/)[1],console.log("检索关键字["+n+"] 完成"),window.g_cache[n]=e,idx=e.indexOf("relatedkeywords"),endIdx=e.indexOf('<div class="adBta">'),-1!=idx&&endIdx>idx)count=e.match(/<span class="count _medium">(.+?)<\/span>/)[1].split(/[（）]/)[1],d='<div class="dui-container '+e.substring(idx,endIdx).replace("</h3>",count+"</h3>");else{if(body=$(e),count=body.find(".count._medium").text().split(/[（）]/)[1],d=body.find(".relatedkeywords").prop("outerHTML"),!d)return void console.log("关键字["+n+"] 找不到指定的数据");d=d.replace("</h3>",count+"</h3>")}$(".main").append(d),$(d).find(".item").each((e,a)=>{var d=$(a).text();window.g_search[n]||(window.g_search[n]=[]),window.g_search[n].push(d)}),n==a[a.length-1]&&setTimeout(()=>{layer.closeAll();var e=["<h3>"];e.push('<a href="javascript:searchAll()" class="dui-button" style="color:red">采集数据</a>&nbsp;&nbsp;'),e.push('<a href="javascript:downloadData(0)" class="dui-button download" style="color:blue;display:none;">下载数据</a>&nbsp;&nbsp;'),e.push('<a href="javascript:downloadData(1)" class="dui-button download" style="color:blue;display:none;">下载关键字</a>&nbsp;&nbsp;'),e.push('<a href="javascript:downloadData(2)" class="dui-button download" style="color:blue;display:none;">下载TOP5</a>&nbsp;&nbsp;'),e.push("</h3><br/>"),$(".main").append(e.join("")),$(".relatedkeywords a").attr("target","_blank")},2e3)}}}function doSearch(e,a){$.get(searchBaseUrl+e+"/",doSearchCallBack(a))}function doKeywords(){layer.prompt({title:"输入关键字，并确认",formType:0},function(e,a){layer.close(a),layer.load(0),window.g_search={},window.g_data={},window.g_cache={},window.g_keyword_first=e,window.g_search[e]=[],$.get(searchBaseUrl+e+"/",function(e){var a,d;e=safeHtml(e),idx=e.indexOf('<div class="dui-container nav">'),endIdx=e.indexOf('<div class="dui-container main">'),idx>0&&endIdx>idx&&(nav=e.substring(idx,endIdx),d=$(nav).find(".keyword").text().split(/[「」]/)[1],console.log("检索关键字["+d+"] 完成"),window.g_cache[d]=e,idx=e.indexOf("relatedkeywords"),endIdx=e.indexOf('<div class="adBta">'),-1!=idx&&endIdx>idx?(count=e.match(/<span class="count _medium">(.+?)<\/span>/)[1].split(/[（）]/)[1],a='<div class="dui-container '+e.substring(idx,endIdx).replace("</h3>",count+"</h3>")):(body=$(e),count=body.find(".count._medium").text().split(/[（）]/)[1],a=body.find(".relatedkeywords").prop("outerHTML").replace("</h3>",count+"</h3>")),$(".main").append(a),$(".relatedkeywords .item").each((e,a)=>{var n=$(a).text();window.g_search[d].push(n),doSearch(n,d)}))})})}function safeHtml(e){return e.replace(/[\r\n]/g,"").replace(/<script.+?<\/script>/g,"").replace(/<img.+?>/g,"").replace(/<link.+?>/g,"").replace(/<style.+?<\/style>/g,"").replace(/-big/g,"")}function sortBy(e,a){return a.legend-e.legend}function downloadData(e){var a=(new Date).getTime();if(filename="全部数据-"+a+".txt",1==e?filename="全部关键字-"+a+".txt":2==e&&(filename="TOP5数据-"+a+".txt"),1==window.g_download){var d=[];if(1==e){var n=window.g_keyword_first,t=window.g_search[n];d.push(n);for(var o=0;o<t.length;o++){d.push("\t"+t[o]);for(var r=window.g_search[t[o]],i=0;i<r.length;i++)d.push("\t\t"+r[i])}}else for(var s in window.g_data)if("keywords"!=s){t=window.g_data[s];0==e&&d.push("\n\n"+s),top5=[];for(o=0;o<t.length;o++)0==e&&d.push("\t"+t[o].title),o<5&&top5.push("\t"+t[o].title);d.push(s+" (TOP5)"),d.push(top5.join("\n"))}var l=d.join("\n"),c=$("#textarea");0==c.length?$(".main").append('<textarea rows="50" id="textarea" autofocus="autofocus" readonly cols="280">'+l+"</textarea>"):c.val(l);var u=new Blob([l],{type:"text/plain"}),h=document.createElement("a");return h.download=filename,h.href=window.URL.createObjectURL(u),h.click(),void $(h).remove()}layer.alert("还没有准备好数据，请先获取数据")}function searchFinished(e){var a=window.g_data.keywords;window.g_data[e].sort(sortBy),e==a[a.length-1]&&setTimeout(()=>{layer.close(window.loadIdx),$(".download").show(),window.g_download=1},2e3)}function searchAllCallBack(e){var a;idx=e.indexOf('<div class="dui-container nav">'),endIdx=e.indexOf('<div class="dui-container main">'),idx>0&&endIdx>idx&&(nav=e.substring(idx,endIdx),a=$(nav).find(".keyword").text().split(/[「」]/)[1],console.log("检索关键字["+a+"] 完成"),window.g_cache[a]=e,window.g_data[a]=[],idx=e.indexOf("searchresults"),endIdx=e.indexOf("relatedkeywords"),-1!=idx&&endIdx>idx&&(e='<div class="dui-container '+e.substring(idx,endIdx)+'"></div>',body=$(e),body.find(".searchresultitem").each((e,d)=>{var n=$(d).find(".title").text(),t=$(d).find(".score").text(),o=$(d).find(".legend").text();""==t&&(t=0),o=""==o?0:parseInt(o.replace(/[^\d]/g,"")),"PR"!=n.substring(0,2)&&window.g_data[a].push({title:n,legend:o,score:t})})),searchFinished(a))}function searchAll(){window.g_data={},window.g_data.keywords=[],window.loadIdx=layer.load(0),$(".download").hide(),window.g_download=0,$(".relatedkeywords .item").each((e,a)=>{var d=$(a).text();if(-1==window.g_data.keywords.indexOf(d)){window.g_data.keywords.push(d);var n=window.g_cache[d];n?searchAllCallBack(n):$.get(searchBaseUrl+d+"/",function(e){e=safeHtml(e),searchAllCallBack(e)})}})}function doHook(){if(-1==location.href.indexOf("//search.rakuten.co.jp/search/mall")&&confirm("只支持在指定页面运行，是否调到指定页面？"))location.href="//search.rakuten.co.jp/search/mall";else{"undefined"==typeof searchBaseUrl&&(searchBaseUrl="/search/mall/");var e=document.querySelector("head");if("undefined"==typeof jQuery){if(!document.getElementById("hasJquery")){console.error("开始注入标准库1");let a=document.createElement("script");a.src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js",a.id="hasJquery",e.appendChild(a)}return console.error(new Date+" 标准库1注入未完成，等待中...."),void setTimeout(doHook,2e3)}if(console.info("标准库1已经完成注入"),"undefined"==typeof layer){if(document.getElementById("hasLayer")){if(!document.getElementById("hasLayer1")){let a=document.createElement("script");a.src="https://api.secretzq.com/secretzq/js/layer.js",a.id="hasLayer1",e.appendChild(a);let d=document.createElement("link");d.href="https://api.secretzq.com/secretzq/css/layer.css",d.rel="stylesheet",e.appendChild(d)}}else{console.error("开始注入标准库2");let a=document.createElement("script");a.src="https://cdn.bootcdn.net/ajax/libs/layer/2.3/layer.js",a.id="hasLayer",e.appendChild(a);let d=document.createElement("link");d.href="https://cdn.bootcdn.net/ajax/libs/layer/2.3/skin/layer.css",d.rel="stylesheet",e.appendChild(d)}return console.error(new Date+" 标准库2注入未完成，等待中...."),void setTimeout(doHook,2e3)}console.info("标准库2已经完成注入"),$(".header,.nav,.footer,.anshin,.corporate,.tooltip,.overlay").remove(),$(".main").html('<h1>脚本注入成功，功能说明：</h1><h3>1.输入<a href="javascript:doKeywords()" class="dui-button -big" style="color:red">关键字</a><br/>2.点搜索<br/>3.下拉到页面底部，找到热搜词 <br/>4.点击热搜词<br/>5.抓取打开页面评论最多的前5个，如果都不足5个，有多少取多少。（标题和图片）<br/>6 抓取整页的所有关键词，除打广告的除外<br/>7 重复456步骤，将第3步的所有热搜词和整页的词全部抓取一次<br/>8 完成第7步后，分别统计前5标题的词频和全面标题的词频<br/><br/> </h3>')}}window.g_keyword_first="",window.g_download=0,doHook();