function doSearchCallBack(parentKeyword){var arr=window.g_search[parentKeyword];return function(d){var html,keyword;if(d=safeHtml(d),idx=d.indexOf('<div class="dui-container nav">'),endIdx=d.indexOf('<div class="dui-container main">'),idx>0&&endIdx>idx){if(nav=d.substring(idx,endIdx),keyword=$(nav).find(".keyword").text().split(/[「」]/)[1],console.log("检索关键字["+keyword+"] 完成"),window.g_cache[keyword]=d,idx=d.indexOf("relatedkeywords"),endIdx=d.indexOf('<div class="adBta">'),-1!=idx&&endIdx>idx)count=d.match(/<span class="count _medium">(.+?)<\/span>/)[1].split(/[（）]/)[1],html='<div class="dui-container '+d.substring(idx,endIdx).replace("</h3>",count+"</h3>");else{if(body=$(d),count=body.find(".count._medium").text().split(/[（）]/)[1],!(html=body.find(".relatedkeywords").prop("outerHTML")))return void console.log("关键字["+keyword+"] 找不到指定的数据");html=html.replace("</h3>",count+"</h3>")}$(".main").append(html),$(html).find(".item").each((idx,el)=>{var subkeyword=$(el).text();window.g_search[keyword]||(window.g_search[keyword]=[]),window.g_search[keyword].push(subkeyword)}),keyword==arr[arr.length-1]&&setTimeout(()=>{layer.closeAll();var html=["<h3>"];html.push('<a href="javascript:searchAll()" class="dui-button" style="color:red">采集数据</a>&nbsp;&nbsp;'),html.push('<a href="javascript:downloadData(0)" class="dui-button download" style="color:blue;display:none;">下载数据</a>&nbsp;&nbsp;'),html.push('<a href="javascript:downloadData(1)" class="dui-button download" style="color:blue;display:none;">下载关键字</a>&nbsp;&nbsp;'),html.push('<a href="javascript:downloadData(2)" class="dui-button download" style="color:blue;display:none;">下载TOP5</a>&nbsp;&nbsp;'),html.push("</h3><br/>"),$(".main").append(html.join("")),$(".relatedkeywords a").attr("target","_blank")},2e3)}}}function doSearch(keyword,parentKeyword){$.get(searchBaseUrl+keyword+"/",doSearchCallBack(parentKeyword))}function doKeywords(){layer.prompt({title:"输入关键字，并确认",formType:0},(function(keyword,index){layer.close(index),layer.load(0),window.g_search={},window.g_data={},window.g_cache={},window.g_keyword_first=keyword,window.g_search[keyword]=[],$.get(searchBaseUrl+keyword+"/",(function(d){var html,keyword;d=safeHtml(d),idx=d.indexOf('<div class="dui-container nav">'),endIdx=d.indexOf('<div class="dui-container main">'),idx>0&&endIdx>idx&&(nav=d.substring(idx,endIdx),keyword=$(nav).find(".keyword").text().split(/[「」]/)[1],console.log("检索关键字["+keyword+"] 完成"),window.g_cache[keyword]=d,idx=d.indexOf("relatedkeywords"),endIdx=d.indexOf('<div class="adBta">'),-1!=idx&&endIdx>idx?(count=d.match(/<span class="count _medium">(.+?)<\/span>/)[1].split(/[（）]/)[1],html='<div class="dui-container '+d.substring(idx,endIdx).replace("</h3>",count+"</h3>")):(body=$(d),count=body.find(".count._medium").text().split(/[（）]/)[1],html=body.find(".relatedkeywords").prop("outerHTML").replace("</h3>",count+"</h3>")),$(".main").append(html),$(".relatedkeywords .item").each((idx,el)=>{var subkeyword=$(el).text();window.g_search[keyword].push(subkeyword),doSearch(subkeyword,keyword)}))}))}))}function safeHtml(d){return d.replace(/[\r\n]/g,"").replace(/<script.+?<\/script>/g,"").replace(/<img.+?>/g,"").replace(/<link.+?>/g,"").replace(/<style.+?<\/style>/g,"").replace(/-big/g,"")}function sortBy(a,b){return b.legend-a.legend}function downloadData(flag){var now=(new Date).getTime();if(filename="全部数据-"+now+".txt",1==flag?filename="全部关键字-"+now+".txt":2==flag&&(filename="TOP5数据-"+now+".txt"),1==window.g_download){var titles=[];if(1==flag){var firstkey=window.g_keyword_first,arr=window.g_search[firstkey];titles.push(firstkey);for(var i=0;i<arr.length;i++){titles.push("\t"+arr[i]);for(var arr1=window.g_search[arr[i]],j=0;j<arr1.length;j++)titles.push("\t\t"+arr1[j])}}else for(var key in window.g_data)if("keywords"!=key){var arr=window.g_data[key];0==flag&&titles.push("\n\n"+key),top5=[];for(var i=0;i<arr.length;i++)0==flag&&titles.push("\t"+arr[i].title),i<5&&top5.push("\t"+arr[i].title);titles.push(key+" (TOP5)"),titles.push(top5.join("\n"))}var content=titles.join("\n"),textArea=$("#textarea");0==textArea.length?$(".main").append('<textarea rows="50" id="textarea" autofocus="autofocus" readonly cols="280">'+content+"</textarea>"):textArea.val(content);var textFileAsBlob=new Blob([content],{type:"text/plain"}),downloadLink=document.createElement("a");return downloadLink.download=filename,downloadLink.href=window.URL.createObjectURL(textFileAsBlob),downloadLink.click(),void $(downloadLink).remove()}layer.alert("还没有准备好数据，请先获取数据")}function searchFinished(keyword){var allKeywords=window.g_data.keywords;window.g_data[keyword].sort(sortBy),keyword==allKeywords[allKeywords.length-1]&&setTimeout(()=>{layer.close(window.loadIdx),$(".download").show(),window.g_download=1},2e3)}function searchAllCallBack(d){var html,keyword;idx=d.indexOf('<div class="dui-container nav">'),endIdx=d.indexOf('<div class="dui-container main">'),idx>0&&endIdx>idx&&(nav=d.substring(idx,endIdx),keyword=$(nav).find(".keyword").text().split(/[「」]/)[1],console.log("检索关键字["+keyword+"] 完成"),window.g_cache[keyword]=d,window.g_data[keyword]=[],idx=d.indexOf("searchresults"),endIdx=d.indexOf("relatedkeywords"),-1!=idx&&endIdx>idx&&(d='<div class="dui-container '+d.substring(idx,endIdx)+'"></div>',body=$(d),body.find(".searchresultitem").each((idx,el)=>{var title=$(el).find(".title").text(),score=$(el).find(".score").text(),legend=$(el).find(".legend").text();""==score&&(score=0),legend=""==legend?0:parseInt(legend.replace(/[^\d]/g,"")),"PR"!=title.substring(0,2)&&window.g_data[keyword].push({title:title,legend:legend,score:score})})),searchFinished(keyword))}function searchAll(){window.g_data={},window.g_data.keywords=[],window.loadIdx=layer.load(0),$(".download").hide(),window.g_download=0,$(".relatedkeywords .item").each((idx,el)=>{var keyword=$(el).text();if(-1==window.g_data.keywords.indexOf(keyword)){window.g_data.keywords.push(keyword);var d=window.g_cache[keyword];d?searchAllCallBack(d):$.get(searchBaseUrl+keyword+"/",(function(d){searchAllCallBack(d=safeHtml(d))}))}})}function doHook(){if("undefined"==typeof searchBaseUrl&&(searchBaseUrl="/search/mall/"),"undefined"==typeof jQuery){if(!document.getElementById("hasJquery")){console.log("开始注入标准库1");var head=document.getElementsByTagName("head")[0];head.innerHTML=head.innerHTML+'<script src="https://cdn.bootcdn.net/ajax/libs/jquery/2.2.4/jquery.min.js"><\/script><input type="hidden" id="hasJquery"/>'}return console.log(new Date+" 标准库1注入未完成，等待中...."),void setTimeout(doHook,1e3)}if(console.log("标准库1已经完成注入"),"undefined"==typeof layer)return document.getElementById("hasLayer")||(console.log("开始注入标准库2"),jQuery("head").append('<link href="https://cdn.bootcdn.net/ajax/libs/layer/2.3/skin/layer.css" rel="stylesheet"><script src="https://cdn.bootcdn.net/ajax/libs/layer/2.3/layer.js"><\/script><input type="hidden" id="hasLayer"/>')),console.log(new Date+" 标准库2注入未完成，等待中...."),void setTimeout(doHook,1e3);console.log("标准库2已经完成注入"),$(".header,.nav,.footer,.anshin,.corporate,.tooltip,.overlay").remove(),$(".main").html('<h1>脚本注入成功，功能说明：</h1><h3>1.输入<a href="javascript:doKeywords()" class="dui-button -big" style="color:red">关键字</a><br/>2.点搜索<br/>3.下拉到页面底部，找到热搜词 <br/>4.点击热搜词<br/>5.抓取打开页面评论最多的前5个，如果都不足5个，有多少取多少。（标题和图片）<br/>6 抓取整页的所有关键词，除打广告的除外<br/>7 重复456步骤，将第3步的所有热搜词和整页的词全部抓取一次<br/>8 完成第7步后，分别统计前5标题的词频和全面标题的词频<br/><br/> </h3>')}window.g_keyword_first="",window.g_download=0,doHook();